<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.20.1 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Mozzi</title>
<meta name="description" content="audio synthesis library for Arduino">


  <meta name="author" content="Tim Barrass">


<meta property="og:type" content="website">
<meta property="og:locale" content="en_GB">
<meta property="og:site_name" content="Mozzi">
<meta property="og:title" content="Mozzi">
<meta property="og:url" content="http://localhost:4000/Mozzi/learn/under-the-hood/">


  <meta property="og:description" content="audio synthesis library for Arduino">



  <meta property="og:image" content="http://localhost:4000/Mozzi/assets/images/mozzi-square.png">









  

  


<link rel="canonical" href="http://localhost:4000/Mozzi/learn/under-the-hood/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Tim Barrass",
      "url": "http://localhost:4000/Mozzi/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/Mozzi/feed.xml" type="application/atom+xml" rel="alternate" title="Mozzi Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/Mozzi/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/Mozzi/">
          Mozzi
          
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/Mozzi/download/">download</a>
            </li><li class="masthead__menu-item">
              <a href="/Mozzi/gallery/">gallery</a>
            </li><li class="masthead__menu-item">
              <a href="/Mozzi/examples/">examples</a>
            </li><li class="masthead__menu-item">
              <a href="/Mozzi/learn/">learn</a>
            </li><li class="masthead__menu-item">
              <a href="https://groups.google.com/forum/?utm_medium=email&utm_source=footer#!forum/mozzi-users">forum</a>
            </li><li class="masthead__menu-item">
              <a href="/Mozzi/doc/html/">api</a>
            </li><li class="masthead__menu-item">
              <a href="https://github.com/sensorium/Mozzi">github</a>
            </li></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle Menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      
  







<div class="page__hero--overlay"
  style=" background-image: url('/Mozzi/assets/images/mozzi-square.png');"
>
  
    <div class="wrapper">
      <h1 id="page-title" class="page__title" itemprop="headline">
        
          Mozzi

        
      </h1>
      
      


      
      
    </div>
  
  
</div>





<div id="main" role="main">
  


  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    
    
    
    

    <div class="page__inner-wrap">
      

      <section class="page__content" itemprop="text">
        
        <p>The interface between Mozzi and the Arduino environment consists of four main functions. These are <code class="language-plaintext highlighter-rouge">startMozzi()</code>, <code class="language-plaintext highlighter-rouge">updateAudio()</code>, <code class="language-plaintext highlighter-rouge">updateControl()</code> and <code class="language-plaintext highlighter-rouge">audioHook()</code>, visible in the “User space” section in the figure below. All four are required for a Mozzi sketch to compile.</p>

<p><img src="/Mozzi/learn/under-the-hood/images/Mozzi-system.jpg" alt="Mozzi system architecture" /></p>

<p><code class="language-plaintext highlighter-rouge">startMozzi(control_rate)</code> goes in Arduino’s <code class="language-plaintext highlighter-rouge">setup()</code>. It starts a timer which regularly sends audio out from the audio output buffer, and calls updateControl() at the requested control rate given in Hz as a parameter, or defaulting to 64 Hz without a parameter.</p>

<p><code class="language-plaintext highlighter-rouge">updateControl()</code> is where any analog or digital input sensing code should be placed and relatively slow changes such as LFO’s or frequency changes can be performed.</p>

<p><code class="language-plaintext highlighter-rouge">updateAudio()</code> is where audio synthesis code should be placed. This runs on average 16384 times per second, so code here needs to be lean. The only other strict requirement is that it returns an integer between -244 and 243 inclusive in STANDARD mode or -8192 to 8191 in HIFI mode.</p>

<p><code class="language-plaintext highlighter-rouge">audioHook()</code> goes in Arduino’s <code class="language-plaintext highlighter-rouge">loop()</code>. It wraps <code class="language-plaintext highlighter-rouge">updateAudio()</code> and takes care of filling the output buffer, hiding the details of this from user space.</p>

<p>Mozzi uses hardware interrupts on the processor which automatically call
interrupt service routines (ISR) at regular intervals. <code class="language-plaintext highlighter-rouge">startMozzi()</code> sets
up an interrupt for audio output at a sample rate of 16384 Hz. A counter in the audio output routine is used to call <code class="language-plaintext highlighter-rouge">updateControl</code>.  In earlier versions, a separate interrupt on Timer 0 was used for control.</p>

<p>In <code class="language-plaintext highlighter-rouge">STANDARD_PLUS</code> (and old <code class="language-plaintext highlighter-rouge">STANDARD</code>) mode, the 16 bit Timer 1 is used by Mozzi on the ATmega processors for audio and control.</p>

<p><code class="language-plaintext highlighter-rouge">HIFI</code> mode additionally employs Timer 2 with Timer 1 for audio.</p>

<p>The output buffer has 256 cells which equates to a maximum latency of about 15 milliseconds, to give leeway for control operations without interrupting audio output. The buffer is emptied behind the scenes by the regular 16384 Hz audio interrupt.</p>

        
      </section>

      <footer class="page__meta">
        
        


        

      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    

    <li><a href="/Mozzi/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Tim Barrass. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/Mozzi/assets/js/main.min.js"></script>










  </body>
</html>
